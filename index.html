<script>
    /*********************************************************
     * 1. BIN ROTATION RULES FOR THIS STREET
     *
     * You ONLY edit this section when things change.
     * - start: first known collection date for that bin (yyyy-mm-dd)
     * - freqWeeks: how often it repeats
     * - label: how we display it in the UI
     *********************************************************/
    const binRules = [
        {
            label: "Black Bin (General Recycling)",
            start: "2025-10-27", // Next Collection 27/10/2025
            freqWeeks: 3
        },
        {
            label: "Blue Bin (Cardboard and Paper)",
            start: "2025-11-03", // Next Collection 03/11/2025
            freqWeeks: 3
        },
        {
            label: "Purple Bin (General Waste)",
            start: "2025-11-10", // Next Collection 10/11/2025
            freqWeeks: 3
        },
        {
            label: "Brown Bin (Gardening Waste)",
            start: "2025-10-27", // Next Collection 27/10/2025
            freqWeeks: 2
        },
        {
            label: "Little Brown Bin (Food Waste)",
            start: "2025-10-27", // Next Collection 27/10/2025
            freqWeeks: 1
        }
    ];

    /*********************************************************
     * 2. HELPER UTILITIES
     *********************************************************/
    function parseYmd(ymd) {
        const [y, m, d] = ymd.split("-").map(Number);
        return new Date(y, m - 1, d);
    }

    function formatYmd(dateObj) {
        const y = dateObj.getFullYear();
        const m = String(dateObj.getMonth() + 1).padStart(2, "0");
        const d = String(dateObj.getDate()).padStart(2, "0");
        return `${y}-${m}-${d}`;
    }

    function prettyDate(d) {
        return d.toLocaleDateString(undefined, {
            weekday: "short",
            day: "numeric",
            month: "short",
            year: "numeric"
        });
    }

    // difference in weeks between two dates, rounded down
    function weeksBetween(startDate, currentDate) {
        const msPerWeek = 7 * 24 * 60 * 60 * 1000;
        const diffMs = currentDate - startDate;
        return Math.floor(diffMs / msPerWeek);
    }

    // is this bin collected on this monday?
    function binIsDueOnDate(binRule, dateObj) {
        // must be same weekday (Monday) or later date logic will accidentally tick things midweek
        // but we're only going to feed Mondays anyway.
        const startDate = parseYmd(binRule.start);
        if (dateObj < startDate) return false;

        const w = weeksBetween(startDate, dateObj);
        return (w % binRule.freqWeeks) === 0;
    }

    // get the next N Mondays starting from today (or from a fixed anchor if you want)
    function getUpcomingMondays(numMondays = 12) {
        const out = [];
        const today = new Date();

        // find next Monday (or today if today is Monday)
        const d = new Date(today);
        const dayOfWeek = d.getDay(); // 0 Sun, 1 Mon, ...
        const daysUntilMonday = (1 - dayOfWeek + 7) % 7;
        d.setDate(d.getDate() + daysUntilMonday);

        // now collect numMondays Mondays
        for (let i = 0; i < numMondays; i++) {
            out.push(new Date(d));
            d.setDate(d.getDate() + 7); // jump 1 week
        }

        return out;
    }

    /*********************************************************
     * 3. BUILD collections[] AUTOMATICALLY
     *
     * Result will look like:
     * [
     *   { date: "2025-10-27", bins: ["Black Bin ...","Brown Bin ...","Little Brown Bin ..."] },
     *   { date: "2025-11-03", bins: ["Blue Bin ...","Little Brown Bin ..."] },
     *   ...
     * ]
     *********************************************************/
    function buildCollections() {
        const mondays = getUpcomingMondays(12); // generate 12 Mondays ahead
        const schedule = [];

        mondays.forEach(mondayDate => {
            const binsForThisMonday = [];

            binRules.forEach(rule => {
                if (binIsDueOnDate(rule, mondayDate)) {
                    binsForThisMonday.push(rule.label);
                }
            });

            // only include Mondays where at least 1 bin is due
            if (binsForThisMonday.length > 0) {
                schedule.push({
                    date: formatYmd(mondayDate),
                    bins: binsForThisMonday
                });
            }
        });

        return schedule;
    }

    // This is what the rest of the app expects:
    const collections = buildCollections();

    /*********************************************************
     * 4. IMAGE PICKER (unchanged)
     *********************************************************/
    function getBinImage(binName) {
        if (/little brown/i.test(binName)) return "food-bin.png";
        if (/brown bin/i.test(binName)) return "brown-bin.png";
        if (/black bin/i.test(binName)) return "black-bin.png";
        if (/blue bin/i.test(binName)) return "blue-bin.png";
        if (/purple bin/i.test(binName)) return "purple-bin.png";
        return null;
    }

    /*********************************************************
     * 5. RENDER LOGIC (mostly unchanged from Street Edition)
     *********************************************************/
    function getNextCollection(forDateYmd) {
        return collections.find(c => c.date >= forDateYmd) || null;
    }

    function getUpcoming(limit = 3, startAfterYmd) {
        return collections.filter(c => c.date >= startAfterYmd).slice(0, limit);
    }

    function render() {
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(now.getDate() + 1);

        const tomorrowYmd = formatYmd(tomorrow);
        const tonightCollection = getNextCollection(tomorrowYmd);

        const dateLabel = document.getElementById("dateLabel");
        const headline = document.getElementById("headline");
        const binsEl = document.getElementById("bins");
        const statusMsg = document.getElementById("statusMsg");
        const nextEl = document.getElementById("nextCollections");

        dateLabel.textContent = `for Mon AM ${prettyDate(tomorrow)}`;
        binsEl.innerHTML = "";
        statusMsg.textContent = "";
        nextEl.textContent = "";

        if (!tonightCollection) {
            headline.textContent = "No collection info ðŸ”„";
            statusMsg.textContent = "Schedule might need an update.";
            return;
        }

        headline.textContent = tonightCollection.bins.length > 1
            ? "Put these out tonight:"
            : `Put out: ${tonightCollection.bins[0]}`;

        tonightCollection.bins.forEach(binName => {
            const pill = document.createElement("div");
            pill.className = "bin-pill";

            const left = document.createElement("div");
            left.className = "bin-left";

            const main = document.createElement("div");
            main.className = "bin-name";
            main.textContent = binName;

            const note = document.createElement("div");
            note.className = "bin-notes";

            if (/little brown/i.test(binName)) note.textContent = "Food Waste (every week)";
            else if (/brown bin/i.test(binName)) note.textContent = "Gardening Waste";
            else if (/black bin/i.test(binName)) note.textContent = "General Recycling (cans, plastic, glass)";
            else if (/blue bin/i.test(binName)) note.textContent = "Cardboard & Paper";
            else if (/purple bin/i.test(binName)) note.textContent = "General Waste";

            left.appendChild(main);
            left.appendChild(note);

            const imgSrc = getBinImage(binName);
            if (imgSrc) {
                const img = document.createElement("img");
                img.className = "bin-img";
                img.src = imgSrc;
                img.alt = binName;
                pill.appendChild(left);
                pill.appendChild(img);
            } else {
                pill.appendChild(left);
            }

            binsEl.appendChild(pill);
        });

        const dParts = tonightCollection.date.split("-");
        const collDate = new Date(+dParts[0], +dParts[1] - 1, +dParts[2]);
        statusMsg.textContent = `These bins will be collected on ${prettyDate(collDate)} morning for this street.`;

        const upcoming = getUpcoming(3, tomorrowYmd);
        if (upcoming.length > 1) {
            nextEl.textContent = "Next collections:\n" + upcoming.map(c => {
                const [y, m, d] = c.date.split("-");
                const dObj = new Date(+y, +m - 1, +d);
                return `${prettyDate(dObj)} â†’ ${c.bins.join(", ")}`;
            }).join("\n");
        }
    }

    // fire it up
    render();
</script>